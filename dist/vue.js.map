{"version":3,"file":"vue.js","sources":["../src/observe/array.js","../src/observe/index.js","../src/state.js","../src/compiler/index.js","../src/init.js","../src/index.js"],"sourcesContent":["// 我们希望重新数组的部分方法\n// 思路： 改变原型链、AOP函数劫持：内部调用原本的方法前后新加逻辑\n\n// 获取数组的原型\nlet oldArrayProtoMethods = Array.prototype;\n\n// 基于Array.prototype创建一个新的对象\n// 让数组类型的value的__proto__指向下面的对象，等于修改了原型链\n// arrayMethods.__proto__ = oldArrayProtoMethods;\n// value.__proto__ == arrayMethods\nexport let arrayMethods = Object.create(oldArrayProtoMethods);\n\n// 所有的变异方法7个：能修改原数组的方法： 对头（尾）\n// concat、slice不能修改原数组\nlet methods = [\"push\", \"pop\", \"shift\", \"unshift\", \"reverse\", \"sort\", \"splice\"];\n\nmethods.forEach((method) => {\n  // arrayMethods上面的加的方法只会影响arrayMethods上面的方法，不会覆盖Array.prototype上的原本的方法\n  // 通过原型链找到了arrayMethods的push就不会继续去找Array.prototype上的push方法\n  // 重新arrayMethods上的7个方法\n  // arr.push(1,2,3)\n  arrayMethods[method] = function (...args) {\n    // 这里重写了数组的方法\n    // 旧方法: 在新的方法里面调用\n    // this就是arr\n    const result = oldArrayProtoMethods[method].apply(this, args); // 内部调用原来的方法，函数的劫持，面向切片变成\n\n    console.log(\"array method: \", method);\n\n    // 底下为AOP的增加自己的逻辑\n\n    // this是arr，谁调用的push就是谁\n    // this就是Observer中的那个value\n    const ob = this.__ob__;\n    // 新增的数组\n    let inserted;\n    // push和unshift会新增数据，新增的数据也需要劫持\n    // splice也可能会新增数据\n    switch (method) {\n      case \"push\":\n      case \"unshift\":\n        inserted = args; // arr.unshift(1, 2, 3) // 新增的内容是一个数组\n        break;\n      case \"splice\":\n        inserted = args.slice(2); // arr.splice(0, 1, {a: 1}, {b: 2}) 第2个参数后面的参数是新增的内容是数组\n      default:\n        break;\n    }\n    // 对数组类型的数据进行观察劫持\n    if (inserted) ob.observeArray(inserted); // 对新增的数据（数组）再次进行观测劫持\n    return result;\n  };\n});\n","import { arrayMethods } from \"./array\";\nclass Observer {\n  // 观测值\n  constructor(value) {\n    // 给所有响应式数据增加标识，并且可以在响应式上获取Observer实例上的方法\n    // 如果数据上已经有了__ob__标识，证明已经被代理过了\n    // 增加__ob__属性为this，目的是可以在value上取到this从而调用Observer类上的方法\n    // 等同于value.__ob__ = this；但是没有控制可以枚举性，会导致下面defineReactive的时候死循环\n    // 值是this，但是不可枚举，循环的时候无法获取，从而解决了死循环的问题\n    Object.defineProperty(value, \"__ob__\", {\n      enumerable: false,\n      configurable: false,\n      value: this,\n    });\n\n    if (Array.isArray(value)) {\n      // 重新数组的7个变异方法，为啥是变异方法，因为会修改原数组\n\n      // 需要保留数组原有的方法，并且可以重写部分方法\n      value.__proto__ = arrayMethods; // 重写数组原型方法\n      // 数组里面的对象引用类型也需要进行劫持\n      this.observeArray(value); // 如果数组中方的是对象，可以监控到对象的改变\n    } else {\n      // 遍历\n      this.walk(value);\n    }\n  }\n\n  // 循环递归（性能差的原因）对象，对对象的所有属性进行劫持\n  walk(data) {\n    // 让对象上的所有属性依次进行观测\n    let keys = Object.keys(data);\n    for (let i = 0; i < keys.length; i++) {\n      let key = keys[i];\n      let value = data[key];\n      // \"重新定义\"属性\n      defineReactive(data, key, value);\n    }\n  }\n\n  // 观测数组\n  observeArray(data) {\n    data.forEach((item) => observe(item));\n  }\n}\n\n// 要暴露的方法，所以不能放到Observer类里面\n// 闭包\nexport function defineReactive(data, key, value) {\n  // 深度属性劫持\n  // 如果value还是object类型，继续调用observe进行递归劫持\n  observe(value);\n\n  // 缺点：Object.defineProperty只能劫持已经存在的属性，对于新增的和删除的操作监听不到\n  // 所以vue中单独写了一些api如$set, $delete来实现属性的新增的和删除后，仍然能做到数据劫持\n  Object.defineProperty(data, key, {\n    get() {\n      console.log(`get key ${key}`);\n\n      // 取值的时候会执行get\n      // 闭包，value不会销毁，能取得到\n      return value;\n    },\n    set(newValue) {\n      // 设值的时候会执行set\n      if (newValue == value) return;\n\n      console.log(`set key ${key} ${newValue}`);\n\n      // 再次劫持\n      // 深度属性劫持\n      // 如果设置的属性的value仍然是对象，继续递归进行新增属性的响应式\n      observe(newValue);\n\n      value = newValue;\n    },\n  });\n}\n\nexport function observe(data) {\n  // 对这个对象进行劫持\n\n  if (typeof data !== \"object\" || data === null) {\n    return; // 只对对象进行劫持\n  }\n\n  // data上有__ob__标识证明已经被观察过了，直接返回原本的Observer就可以了\n  if (data.__ob__ instanceof Observer) {\n    return data.__ob__;\n  }\n\n  // 如果一个对象被劫持过了，那就不需要再被劫持了（需要判断一个对象是否被劫持过，可以添加一个实例，用实例来判断是否被劫持过）\n  return new Observer(data);\n}\n","import { observe } from \"./observe\";\n\nexport function initState(vm) {\n  const opts = vm.$options; // 获取所有的选项\n\n  if (opts.data) {\n    initData(vm);\n  }\n}\n\n// 数据代理\nfunction proxy(vm, target, key) {\n  // vm.name\n  Object.defineProperty(vm, key, {\n    get() {\n      // => vm._data.name\n      return vm[target][key];\n    },\n    set(newValue) {\n      vm[target][key] = newValue;\n    },\n  });\n}\n\n// 初始化data\nfunction initData(vm) {\n  let data = vm.$options.data; // data可能是函数和对象\n  // 根组件可以是function也可以对象，组件必须是函数\n  data = typeof data === \"function\" ? data.call(vm) : data; // data是用户返回的对象\n  // 将data挂载到vm的_data，和vm上直接可以取到属性的proxy不一样\n  vm._data = data;\n  // 数据劫持 vue2用的是Object.defineProperty\n  observe(data);\n\n  // vm.xxx =>(代理到)  vm._data.xxx\n  for (let key in data) {\n    proxy(vm, \"_data\", key);\n  }\n}\n","// 对模版进行编译\nexport function compileToFunctions(template) {\n  console.log(template);\n\n  // 1. 将template转换成AST语法树\n\n  // 2. 生成render方法，render方法执行后返回的结果就是虚拟DOM\n}\n","import { initState } from \"./state\";\nimport { compileToFunctions } from \"./compiler\";\n\nexport function initMixin(Vue) {\n  // 通过原型prototype给Vue增加init方法\n  Vue.prototype._init = function (options) {\n    // 用于初始化操作\n    // vue vm.$options就是获取用户的配置\n\n    // 我们使用vue的时候，$nextTick, $data, $attr...以$开头的都表示Vue的内置属性\n    const vm = this;\n    vm.$options = options; // 将用户的选项挂载到实例上\n\n    // 初始化状态\n    initState(vm);\n\n    if (options.el) {\n      vm.$mount(options.el); // 实现数据的挂载\n    }\n  };\n\n  // 挂载应用\n  Vue.prototype.$mount = function (el) {\n    const vm = this;\n    const options = vm.$options;\n    el = document.querySelector(el);\n\n    // 整体思想：不一定非得有render函数，没有render函数就用template编译成render函数\n    // 先查找有没有render函数\n    if (!options.render) {\n      // 没有render函数的话，再看下是否写了template，写了template就用写了的template\n      // 没有template采用el外部的html\n      let template = options.template;\n      // 没有写template但是写了el\n      if (!template && el) {\n        // 包括el在内的html就是template\n        template = el.outerHTML;\n      }\n\n      // 将模版template编译成render函数\n      const render = compileToFunctions(template); // render函数就是包含h(xxx)\n      options.render = render;\n    }\n\n    // 最终在这里就可以拿到options.render的函数\n    // runtime和runtimeWithComplier\n    // script引用的vue.global.js这个编译过程是在浏览器中执行的\n    // runtime运行时是不包含模板编译的，整个编译是在打包的过程中通过loader编译.vue文件的；\n    // 用runtime的时候不能使用template\n  };\n}\n","import { initMixin } from \"./init\";\n\n// 将所有的方法都耦合在一起\nfunction Vue(options) {\n  // options就是用户的选项\n  this._init(options);\n}\n\ninitMixin(Vue); // 扩展了_init方法\n\nexport default Vue;\n"],"names":["oldArrayProtoMethods","Array","prototype","arrayMethods","Object","create","methods","forEach","method","_len","arguments","length","args","_key","result","apply","console","log","ob","__ob__","inserted","slice","observeArray","Observer","value","_classCallCheck","defineProperty","enumerable","configurable","isArray","__proto__","walk","_createClass","key","data","keys","i","defineReactive","item","observe","get","concat","set","newValue","_typeof","initState","vm","opts","$options","initData","proxy","target","call","_data","compileToFunctions","template","initMixin","Vue","_init","options","el","$mount","document","querySelector","render","outerHTML"],"mappings":"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"}